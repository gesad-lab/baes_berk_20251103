# Implementation Plan: Add Teacher Relationship to Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Teacher Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Add Course Relationship to Student Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan: 
# Implementation Plan: Add Email Field to Student Entity

## Version: 1.0.0  
### Date: 2023-10-29

---

## 1. Overview

This implementation plan outlines the steps to establish a relationship between the `Course` entity and the `Teacher` entity. The primary goal is to enable better management of educational resources by allowing a course to be assigned a teacher, thus enhancing course management functionalities and oversight of educational staff. The plan includes new API endpoints, database schema modifications, data validation mechanisms, and comprehensive testing strategies to ensure integrity and functionality throughout the implementation process.

## 2. Technical Architecture

### 2.1 Architecture Overview
The existing architecture will remain consistent, with additions focused on integrating the teacher-course relationship:
- **Client**: Continued use of the API for interactions concerning course-management functionalities.
- **Server**: FastAPI will manage incoming HTTP requests, handling interactions with the SQLite database.
- **Database**: The existing SQLite database schema for the `Course` table will be updated to include a new `teacher_id` foreign key relationship without disrupting current data integrity.

### 2.2 Updated Component Diagram
```plaintext
+-----------------+
|    Client/API   |
|    (Frontend)   |
+-------+---------+
        |
        v
+-------+--------+
|  FastAPI Server|
| (RESTful API)  |
+-------+--------+
        |
        v
+-------+--------+
|  SQLite Database|
|    +-----------+|
|    | Students  ||
|    | Courses   ||
|    | Teachers   ||
+-----------------+
```

## 3. Technology Stack

- **Programming Language**: Python 3.11+
- **Web Framework**: FastAPI
- **Database**: SQLite
- **ORM**: SQLAlchemy
- **API Documentation**: OpenAPI (automatically generated by FastAPI)
- **Testing Framework**: pytest
- **Environment Management**: Poetry for package management and dependency resolution

## 4. Module Boundaries and Responsibilities

### 4.1 API Module
- **Responsibilities**:
    - Implement `POST /courses/:course_id/assign-teacher` to assign a teacher to a specified course.
    - Implement `GET /courses/:course_id` to retrieve course details, including assigned teacher information.

### 4.2 Database Module
- **Responsibilities**:
    - Extend the `Course` table schema by adding a `teacher_id` column using SQLAlchemy.
    - Ensure relationships between `Course` and `Teacher` entities are enforced through foreign key constraints.

### 4.3 Validation Module
- **Responsibilities**:
    - Validate course IDs and teacher IDs during assignment to ensure they exist in the database.
    - Ensure proper error responses for invalid assignments.

### 4.4 Error Handling Module
- **Responsibilities**:
    - Handle appropriate error responses for requests with missing or invalid fields.

## 5. Data Models

### 5.1 Course Model Update
```python
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from src.database import Base

class Course(Base):
    __tablename__ = 'courses'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    teacher_id = Column(Integer, ForeignKey('teachers.id'), nullable=True)
    
    teacher = relationship("Teacher", back_populates="courses")

class Teacher(Base):
    __tablename__ = 'teachers'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    email = Column(String, nullable=False, unique=True)

    courses = relationship("Course", back_populates="teacher")
```

## 6. API Contracts

### 6.1 Endpoint Definitions

#### POST /courses/:course_id/assign-teacher
- **Request**:
    - **Body**:
      ```json
      {
          "teacher_id": 1
      }
      ```
- **Response**:
    - **200 OK**:
      ```json
      {
          "message": "Teacher assigned to course successfully."
      }
      ```

#### GET /courses/:course_id
- **Response**:
    - **200 OK**:
      ```json
      {
          "id": 1,
          "name": "Mathematics 101",
          "teacher": {
              "id": 1,
              "name": "John Doe"
          }
      }
      ```

### 6.2 Error Responses

- **Course Not Found (404 Not Found)**:
    - **Response**:
      ```json
      {
          "error": {
              "code": "E004",
              "message": "Course not found."
          }
      }
      ```

- **Teacher Not Found (404 Not Found)**:
    - **Response**:
      ```json
      {
          "error": {
              "code": "E005",
              "message": "Teacher not found."
          }
      }
      ```

## 7. Implementation Phases

### 7.1 Phase 1: Setup Environment
- Ensure that the existing environment and dependencies are up-to-date, validating the SQLite connection and FastAPI server is running.

### 7.2 Phase 2: Database Migration
- Create a migration script using Alembic to add the `teacher_id` foreign key to the `Course` table.
- Migration script implementation:
```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.add_column('courses', sa.Column('teacher_id', sa.Integer(), nullable=True))
    op.create_foreign_key('fk_teacher', 'courses', 'teachers', ['teacher_id'], ['id'], ondelete='SET NULL')

def downgrade():
    op.drop_constraint('fk_teacher', 'courses', type_='foreignkey')
    op.drop_column('courses', 'teacher_id')
```

### 7.3 Phase 3: Update API Endpoints
1. **Implement `POST /courses/:course_id/assign-teacher`**:
    - Validate request data for `teacher_id`. If valid, update the `Course` entity to set the `teacher_id`.
   
2. **Implement `GET /courses/:course_id`**:
    - Modify the route to include `teacher` data when retrieving course details.

### 7.4 Phase 4: Update Error Handling
- Ensure validations for course IDs and teacher IDs, returning appropriate error responses when they do not exist.

### 7.5 Phase 5: Testing
- Implement unit and integration tests for the new endpoint covering:
    - Successful assignment of a teacher to a course.
    - Validation errors for non-existent courses or teachers.

### 7.6 Phase 6: Documentation
- Update OpenAPI documentation and README to reflect the newly added API endpoints and functionality.

## 8. Testing Strategy

### 8.1 Test Coverage
- Ensure coverage of:
    - Successful assignments of a teacher to a course with valid input.
    - Validation errors when using non-existent course or teacher IDs.

### 8.2 Test Types
- Utilize unit tests for logic validation and integration tests for endpoint functionality.

## 9. Security & Logging

### 9.1 Security Measures
- Validate both course and teacher input against injection vulnerabilities and ensure proper sanitization.

### 9.2 Logging
- Implement structured logging for notable actions involving course assignments and API interactions.

## 10. Deployment Considerations
- Ensure that the database migration script is run during application startup to set up the `teacher_id` foreign key in the `courses` table properly.

## 11. Maintenance and Scalability
- Maintain awareness of possible future requirements regarding the functionalities of the teacher-course relationship, allowing for adjustments to accommodate new features like performance tracking.

## 12. Technical Trade-offs

- **SQLite Usage**: Retained for simplification since data size and scale remain manageable with current use cases; consider alternatives for larger datasets or concurrent user management.
- **ORM vs. Raw SQL**: SQLAlchemy chosen as the ORM for easy interaction and abstraction but may incur slight performance overhead for very high-frequency operations.

## 13. Success Metrics
- Successful assignment and retrieval scenarios defined in user stories must be met without errors.
- Comprehensive unit tests should be executed, achieving a minimum of 70% code coverage, with critical paths exceeding 90%.

### Existing Code Modifications Necessary:
- **File: src/models.py**
  - Extend the `Course` model to include the `teacher_id` foreign key and the relationship with the `Teacher`.

- **File: src/api.py**
  - Add new endpoints for `POST /courses/:course_id/assign-teacher` and `GET /courses/:course_id`.

### Proposed Test File Modifications:
- **File: tests/test_integration/test_course_api.py**  
```python
def test_assign_teacher_to_course(client):
    response = client.post("/courses/1/assign-teacher", json={"teacher_id": 1})
    assert response.status_code == 200
    assert response.json() == {"message": "Teacher assigned to course successfully."}

def test_assign_teacher_to_non_existent_course(client):
    response = client.post("/courses/999/assign-teacher", json={"teacher_id": 1})
    assert response.status_code == 404
    assert response.json() == {"error": {"code": "E004", "message": "Course not found."}}

def test_assign_non_existent_teacher_to_course(client):
    response = client.post("/courses/1/assign-teacher", json={"teacher_id": 999})
    assert response.status_code == 404
    assert response.json() == {"error": {"code": "E005", "message": "Teacher not found."}}

def test_get_course_with_assigned_teacher(client):
    response = client.get("/courses/1")
    assert response.status_code == 200
    assert "teacher" in response.json()
```

This implementation plan delineates clear actions involved in establishing a teacher-course relationship in the educational management system while maintaining the existing architecture and data integrity. The outlined steps ensure seamless integration of the new functionalities, adhering to the principles established in prior implementations.