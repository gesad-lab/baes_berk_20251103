# Implementation Plan: Add Course Relationship to Student Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan: 
# Implementation Plan: Add Email Field to Student Entity

## Version: 1.0.0  
### Date: 2023-10-29

---

## 1. Overview

This implementation plan outlines the steps to establish a many-to-many relationship between the Student and Course entities in the educational management system. This feature will allow students to be enrolled in multiple courses and will enhance tracking and reporting of student performance. This plan includes modifications to the existing database schema, new API endpoints for managing enrollments, and data validation mechanisms to ensure data integrity.

## 2. Technical Architecture

### 2.1 Architecture Overview
The architecture remains consistent with previous implementations while integrating the new relationship between Students and Courses:
- **Client**: The existing API serves requests related to student enrollments in courses.
- **Server**: FastAPI continues to handle incoming requests and operations through the SQLite database.
- **Database**: SQLite will be updated to include a new join table `StudentCourses` without impacting existing Student and Course data.

### 2.2 Updated Component Diagram
```plaintext
+-----------------+
|    Client/API   |
|    (Frontend)   |
+-------+---------+
        |
        v
+-------+--------+
|  FastAPI Server|
| (RESTful API)  |
+-------+--------+
        |
        v
+-------+--------+
|  SQLite Database|
|    +-----------+|
|    | Students  ||
|    | Courses   ||
|    | StudentCourses ||
+-----------------+
```

## 3. Technology Stack

- **Programming Language**: Python 3.11+
- **Web Framework**: FastAPI
- **Database**: SQLite
- **ORM**: SQLAlchemy
- **API Documentation**: OpenAPI (automatically generated by FastAPI)
- **Testing Framework**: pytest
- **Environment Management**: Poetry for package management and dependency resolution

## 4. Module Boundaries and Responsibilities

### 4.1 API Module
- **Responsibilities**:
    - Implement `POST /students/{studentId}/courses` endpoint to enroll a student in a course.
    - Implement `GET /students/{studentId}/courses` endpoint to retrieve a list of courses a student is enrolled in.

### 4.2 Database Module
- **Responsibilities**:
    - Create and manage the `StudentCourses` join table schema using SQLAlchemy.
    - Handle database operations related to course enrollments.

### 4.3 Validation Module
- **Responsibilities**:
    - Validate incoming data for student ID and course ID during enrollment.

### 4.4 Error Handling Module
- **Responsibilities**:
    - Return appropriate error messages for requests with invalid IDs and handle existing enrollment checks.

## 5. Data Models

### 5.1 StudentCourses Model
```python
from sqlalchemy import Column, ForeignKey, Integer
from sqlalchemy.orm import relationship
from src.database import Base  # Assuming Base is defined in the database module

class StudentCourses(Base):
    __tablename__ = 'student_courses'
    
    student_id = Column(Integer, ForeignKey('students.id'), primary_key=True)
    course_id = Column(Integer, ForeignKey('courses.id'), primary_key=True)

    student = relationship("Student", back_populates="courses")  # Assuming Student model has a back_populate relation
    course = relationship("Course", back_populates="students")   # Assuming Course model has a back_populate relation
```

## 6. API Contracts

### 6.1 Endpoint Definitions

#### POST /students/{studentId}/courses
- **Request**:
    - **Path Parameters**:
        - `studentId`: ID of the student to enroll in the course.
    - **Body**:
      ```json
      {
          "course_id": 1
      }
      ```
- **Response**:
    - **201 Created**:
      ```json
      {
          "message": "Student enrolled in course successfully."
      }
      ```

#### GET /students/{studentId}/courses
- **Response**:
    - **200 OK**:
      ```json
      [
          {
              "course_id": 1,
              "name": "Mathematics 101",
              "level": "Beginner"
          },
          {
              "course_id": 2,
              "name": "Physics 101",
              "level": "Intermediate"
          }
      ]
      ```

### 6.2 Error Responses

- **Validation Error (400 Bad Request)**:
    - **Response**:
      ```json
      {
          "error": {
              "code": "E001",
              "message": "Invalid student ID."
          }
      }
      ```

- **Validation Error (400 Bad Request)**:
    - **Response**:
      ```json
      {
          "error": {
              "code": "E002",
              "message": "Invalid course ID."
          }
      }
      ```

## 7. Implementation Phases

### 7.1 Phase 1: Setup Environment
- Ensure the cloud service is operational and existing packages are current, verifying the SQLite connection.

### 7.2 Phase 2: Database Migration
- Create a migration script using Alembic to create the `StudentCourses` table.
- Migration script implementation:
```python
from alembic import op
import sqlalchemy as sa

def upgrade():
    op.create_table(
        'student_courses',
        sa.Column('student_id', sa.Integer, sa.ForeignKey('students.id'), primary_key=True),
        sa.Column('course_id', sa.Integer, sa.ForeignKey('courses.id'), primary_key=True)
    )

def downgrade():
    op.drop_table('student_courses')
```

### 7.3 Phase 3: Update API Endpoints
1. Implement `POST /students/{studentId}/courses`:
    - Validate request data for course ID. If valid and student exists, create a new record in `StudentCourses`.
2. Implement `GET /students/{studentId}/courses`:
    - Query and retrieve all courses a student is enrolled in from `StudentCourses`.

### 7.4 Phase 4: Update Error Handling
- Enhance error handling to check for the existence of student ID and course ID before proceeding with enrollments.

### 7.5 Phase 5: Testing
- Implement unit tests for the new endpoints covering:
    - Successful enrollment of a student in a course.
    - Validation errors for invalid student and course IDs.
    - Successful retrieval of student courses.

### 7.6 Phase 6: Documentation
- Update OpenAPI documentation and README to reflect the new student-course enrollment endpoints, including request and response structures.

## 8. Testing Strategy

### 8.1 Test Coverage
- Ensure coverage of:
    - Successful enrollment of a student in a course with valid IDs.
    - Validation errors when using invalid IDs.
    - Successful retrieval of courses for a student.

### 8.2 Test Types
- Use unit tests for validation and integration tests for endpoint functionality.

## 9. Security & Logging

### 9.1 Security Measures
- Validate input to prevent SQL injection attacks and ensure proper sanitization of the inputs.

### 9.2 Logging
- Implement structured logging for all enrollment actions and API interactions.

## 10. Deployment Considerations
- Ensure that the database migration script is executed on application startup to properly set up the `StudentCourses` table.

## 11. Maintenance and Scalability
- Consider future migration to a more robust database system (e.g., PostgreSQL) based on user demands and system load.

## 12. Technical Trade-offs

- **SQLite Usage**: Retained for simplicity and ease of testing; may impact scalability at high loads.
- **FastAPI for Performance**: Chosen for rapid API development and high performance when handling multiple requests.

## 13. Success Metrics
- All defined user scenarios for enrolling students and retrieving enrolled courses must succeed.
- Completion of unit and integration tests, with no critical bugs or issues present before deployment.

This implementation plan is structured to develop the Course relationship with the Student entity, following existing architecture while maintaining backward compatibility and preserving data integrity within the system. The outlined steps are intended to ensure a seamless integration into the existing educational management system. 

Existing Code Files Modifications:
- **File: tests/test_integration.py**
  - Add tests for the new endpoints `POST /students/{studentId}/courses` and `GET /students/{studentId}/courses`.

- **File: tests/test_course_api.py**
  - Update with test cases that involve student enrollments and retrieval of student courses. 

Overall, this plan seeks to add a robust relationship between students and courses that can be effectively managed within the educational system while allowing for future growth and changes.