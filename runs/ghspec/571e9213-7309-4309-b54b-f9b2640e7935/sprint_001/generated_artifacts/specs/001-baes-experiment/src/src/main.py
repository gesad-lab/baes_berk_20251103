from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional

app = FastAPI()

# Middleware configuration for handling CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Adjust this in production to restrict origins
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Model for a Student
class Student(BaseModel):
    id: Optional[int] = None
    name: str

# In-memory storage for students (for demonstration purposes)
students_db = []

@app.post("/students", response_model=Student)
async def create_student(student: Student):
    """
    Create a new student.

    Parameters:
    - student: Student model containing name.

    Returns:
    The created student object with an ID.
    """
    student.id = len(students_db) + 1  # Simple ID assignment logic
    students_db.append(student)
    return student

@app.get("/students/{student_id}", response_model=Student)
async def get_student(student_id: int):
    """
    Retrieve a student by ID.

    Parameters:
    - student_id: The unique identifier of the student.

    Returns:
    The student object if found.
    Raises 404 if no student with this ID exists.
    """
    for student in students_db:
        if student.id == student_id:
            return student
    return {"error": {"code": "E404", "message": "Student not found", "details": {}}}

@app.get("/students", response_model=List[Student])
async def get_students():
    """
    Retrieve all students.

    Returns:
    A list of all students stored in the database.
    """
    return students_db

@app.post("/students/validate")
async def validate_student_name(name: str):
    """
    Validate the student name.

    Parameters:
    - name: The name of the student.

    Returns:
    A message indicating success or failure of validation.
    """
    if not name:
        return {"error": {"code": "E001", "message": "Name field is required", "details": {}}}
    return {"message": "Name is valid"}

# Documentation (OpenAPI) is automatically generated by FastAPI.