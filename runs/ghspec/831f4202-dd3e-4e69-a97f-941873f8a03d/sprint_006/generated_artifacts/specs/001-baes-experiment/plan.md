# Implementation Plan: Add Teacher Relationship to Course Entity

---
## INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Teacher Entity

---

## I. Architecture Overview

The Student Management Application will extend its existing architecture to establish a relationship between the `Course` and `Teacher` entities. The updated architecture will consist of the following modules:

1. **API Module**: This module will add new endpoints for assigning a teacher to a course, updating a teacher assignment, and retrieving courses with associated teacher information.

2. **Database Module**: The database schema will be modified to introduce a `teacher_id` foreign key in the `Course` table, linking courses to teachers.

The application will continue to use Python with the FastAPI framework and SQLite for data persistence.

---

## II. Technology Stack

- **Programming Language**: Python 3.9+
- **Framework**: FastAPI
- **Database**: SQLite
- **ORM**: SQLAlchemy
- **Testing Framework**: pytest
- **Documentation**: OpenAPI (auto-generated by FastAPI)
- **Environment Management**: Poetry or pip with `requirements.txt`

---

## III. Module Responsibilities

### 1. API Module
- **Endpoints**:
  - `POST /courses/{id}/assign_teacher`: Assign a teacher to a course by its ID.
  - `PUT /courses/{id}/update_teacher`: Update the assigned teacher for a course.
  - `GET /courses`: Retrieve all courses, including assigned teacher information.

- **Responsibilities**:
  - Validate incoming requests for assigning and updating teacher assignments.
  - Interact with the database module to save and retrieve course records.
  - Return responses in JSON format with appropriate error handling.

### 2. Database Module
- **Data Model**:
  - **Course**:
    - `id`: Integer, primary key, auto-increment.
    - `name`: String, required.
    - `level`: String, required.
    - `teacher_id`: Integer, foreign key referencing `Teacher.id` (nullable).

- **Responsibilities**:
  - Alter the `Course` table structure to accommodate the new foreign key relationship.
  - Implement a migration strategy to ensure no data loss during the schema transition.

---

## IV. Data Models

### Course Model Modifications

```python
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class Course(Base):
    __tablename__ = 'courses'

    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    level = Column(String, nullable=False)
    teacher_id = Column(Integer, ForeignKey('teachers.id'), nullable=True)  # Foreign key to Teacher
    
    teacher = relationship("Teacher", back_populates="courses")  # Establish relationship with Teacher

class Teacher(Base):
    __tablename__ = 'teachers'
    
    id = Column(Integer, primary_key=True, auto_increment=True)
    name = Column(String, nullable=False)
    email = Column(String, nullable=False, unique=True)
    
    # Create reverse relationship
    courses = relationship("Course", back_populates="teacher")
```

---

## V. API Contracts

### 1. Assign Teacher to Course
- **Request**:
  - **Method**: `POST`
  - **Endpoint**: `/courses/{id}/assign_teacher`
  - **Request Body**:
    ```json
    {
      "teacher_id": 1
    }
    ```
- **Response**:
  - **Success** (200 OK):
    ```json
    {
      "message": "Teacher assigned to course successfully."
    }
    ```
  - **Error** (404 Not Found - Course):
    ```json
    {
      "error": {
        "code": "E003",
        "message": "Course not found."
      }
    }
    ```

### 2. Update Teacher Assignment
- **Request**:
  - **Method**: `PUT`
  - **Endpoint**: `/courses/{id}/update_teacher`
  - **Request Body**:
    ```json
    {
      "teacher_id": 2
    }
    ```
- **Response**:
  - **Success** (200 OK):
    ```json
    {
      "message": "Teacher assignment updated successfully."
    }
    ```

### 3. Retrieve List of Courses
- **Request**:
  - **Method**: `GET`
  - **Endpoint**: `/courses`
- **Response**:
  - **Success** (200 OK):
    ```json
    {
      "courses": [
        {
          "id": 1,
          "name": "Math 101",
          "level": "Beginner",
          "teacher": {
            "id": 1,
            "name": "Jane Doe"
          }
        },
        {
          "id": 2,
          "name": "Science 101",
          "level": "Beginner",
          "teacher": null  // No teacher assigned
        }
      ]
    }
    ```

---

## VI. Error Handling and Validation

- The API module will implement input validation for the `teacher_id` when assigning and updating teacher assignments. Errors will trigger relevant error responses as specified in the API contracts above.

---

## VII. Testing Strategy

### 1. Test Coverage
- Aim for a minimum of 90% test coverage for functionalities related to course and teacher management.

### 2. Test Types
- **Unit Tests**: Validate business logic for the API endpoint handlers and model validations.
- **Integration Tests**: Ensure proper interaction between the API and the updated `Course` and `Teacher` tables in the database.

### 3. Test Organization
- Tests will follow the existing structure:
  - Source: `src/api/course.py`
  - Tests: `tests/api/test_course.py`

---

## VIII. Deployment Considerations

### 1. Production Readiness
- The application must successfully initialize and update the database schema to create the foreign key in the `courses` table.
- Update health check endpoints to reflect the addition of new functionalities.

### 2. Migration Strategy
- **Step 1**: Create a migration script that alters the `courses` table to add the `teacher_id` foreign key field.
- **Step 2**: Populate existing course records where applicable without requiring downtime.

```python
# Example migration script to modify the courses table
from sqlalchemy import create_engine, Column, Integer, ForeignKey
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

def alter_courses_table():
    engine = create_engine('sqlite:///app.db')
    connection = engine.connect()
    # Execute SQL command to add foreign key
    connection.execute('ALTER TABLE courses ADD COLUMN teacher_id INTEGER')  # Update existing data structure
```

---

## IX. Configuration Management

### 1. Environment Variables
- Maintain environment settings to protect sensitive data, specifically ensuring no hardcoded values in code bases.

### 2. Default Configuration
- Configuration defaults to support rollback plans and testing environments during deployment.

---

## X. Logging and Monitoring

- Implement structured logging to capture teacher assignment actions and any errors that may occur to streamline operational monitoring.

---

## XI. Documentation

- Update the OpenAPI documentation through FastAPI to reflect new API endpoints for assigning and updating teachers associated with courses, supplemented by a `README.md` file detailing setup and usage instructions.

---

## XII. Trade-offs and Decisions

- **Backward Compatibility**: The migration strategy ensures that existing data models for `Student`, `Course`, and `Teacher` remain intact while incorporating the new relationship.
- **ORM with SQLAlchemy Continues**: This approach simplifies relationships and integrity checks without additional complexity.
- **FastAPI Choice**: Retained for its performance, scalability, and built-in support for OpenAPI documentation.

--- 

This implementation plan details a structured approach to enhance the `Course` entity with a `Teacher` relationship, ensuring compliance with specifications while maintaining the integrity of existing database models.