# Implementation Plan: Create Teacher Entity

---
## INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Add Course Relationship to Student Entity

---

## I. Architecture Overview

The Student Management Application will integrate a new `Teacher` entity, expanding the current architecture to facilitate the management of educational staff. The updated architecture will consist of the following modules:

1. **API Module**: The API module will receive new endpoints for creating and retrieving teachers, as well as handling validation and error responses for teacher creation.
   
2. **Database Module**: The database module will undergo schema updates to introduce a `Teacher` table, ensuring existing `Student` and `Course` data remain intact.

The current implementation continues to utilize Python with the FastAPI framework and SQLite as the persistence layer.

---

## II. Technology Stack

- **Programming Language**: Python 3.9+
- **Framework**: FastAPI
- **Database**: SQLite
- **ORM**: SQLAlchemy
- **Testing Framework**: pytest
- **Documentation**: OpenAPI (auto-generated by FastAPI)
- **Environment Management**: Poetry or pip with `requirements.txt`

---

## III. Module Responsibilities

### 1. API Module
- **Endpoints**:
  - `POST /teachers`: Create a new teacher.
  - `GET /teachers`: Retrieve all existing teachers.

- **Responsibilities**:
  - Validate incoming requests to ensure proper formatting of name and email.
  - Interact with the database module to create and retrieve teacher records.
  - Return responses in JSON format, including error messages for invalid requests.

### 2. Database Module
- **Data Model**:
  - **Teacher** (new):
    - `id`: Integer, primary key, auto-increment.
    - `name`: String, required.
    - `email`: String, required, unique.

- **Responsibilities**:
  - Maintain the integrity of existing data while allowing for the creation and retrieval of `Teacher` records.
  - Implement a migration strategy to introduce the `Teacher` table without affecting existing operations.

---

## IV. Data Models

### Teacher Model

```python
from sqlalchemy import Column, String, Integer, UniqueConstraint
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class Teacher(Base):
    __tablename__ = 'teachers'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String, nullable=False)
    email = Column(String, nullable=False, unique=True)

    __table_args__ = (UniqueConstraint('email', name='uq_teacher_email'),)
```

---

## V. API Contracts

### 1. Create a New Teacher
- **Request**:
  - **Method**: `POST`
  - **Endpoint**: `/teachers`
  - **Request Body**:
    ```json
    {
      "name": "Jane Doe",
      "email": "jane.doe@example.com"
    }
    ```
- **Response**:
  - **Success** (201 Created):
    ```json
    {
      "message": "Teacher created successfully.",
      "teacher": {
        "id": 1,
        "name": "Jane Doe",
        "email": "jane.doe@example.com"
      }
    }
    ```
  - **Error** (400 Bad Request - Invalid Email):
    ```json
    {
      "error": {
        "code": "E001",
        "message": "Invalid email format."
      }
    }
    ```
  - **Error** (409 Conflict - Duplicate Email):
    ```json
    {
      "error": {
        "code": "E002",
        "message": "Email must be unique."
      }
    }
    ```

### 2. Retrieve List of Teachers
- **Request**:
  - **Method**: `GET`
  - **Endpoint**: `/teachers`
- **Response**:
  - **Success** (200 OK):
    ```json
    {
      "teachers": [
        {
          "id": 1,
          "name": "Jane Doe",
          "email": "jane.doe@example.com"
        },
        {
          "id": 2,
          "name": "John Smith",
          "email": "john.smith@example.com"
        }
      ]
    }
    ```

---

## VI. Error Handling and Validation

- The API module will enforce input validation for the name and email fields during teacher creation. Invalid inputs will trigger relevant error responses as specified in the API contracts above.

---

## VII. Testing Strategy

### 1. Test Coverage
- Aim for a minimum of 95% test coverage for business logic related to teacher creation and retrieval.

### 2. Test Types
- **Unit Tests**: Validate business logic for API endpoint handlers and model validations.
- **Integration Tests**: Test interactions between API and the new `Teacher` table in the database.

### 3. Test Organization
- Tests will be structured to mirror source code:
  - Source: `src/api/teacher.py`
  - Tests: `tests/api/test_teacher.py`

---

## VIII. Deployment Considerations

### 1. Production Readiness
- The application must successfully initialize and migrate the database to create the `teachers` table.
- Health check endpoints should be updated to reflect the addition of new functionality.

### 2. Migration Strategy
- **Step 1**: Create a migration script that adds the `teachers` table to the existing database schema.
- **Step 2**: Run the migration without requiring downtime for existing operational functionalities.

```python
# Example migration script for new table
from sqlalchemy import create_engine, Column, String, Integer, Table, MetaData

def add_teacher_table():
    engine = create_engine('sqlite:///app.db')
    metadata = MetaData()

    teachers_table = Table('teachers', metadata,
        Column('id', Integer, primary_key=True, autoincrement=True),
        Column('name', String, nullable=False),
        Column('email', String, nullable=False, unique=True)
    )
    
    metadata.create_all(engine)  # Create the Teacher table
```

---

## IX. Configuration Management

### 1. Environment Variables
- Ensure that environment variables for any sensitive configurations remain appropriately set.

### 2. Default Configuration
- Maintain sensible defaults for application configurations to promote ease of use during initial setup.

---

## X. Logging and Monitoring

- Implement structured logging for teacher-related actions, capturing relevant request and response details for operational monitoring.

---

## XI. Documentation

- Update OpenAPI documentation through FastAPI to include new endpoints for creating and retrieving teachers, supplemented by a `README.md` file detailing setup instructions and API usage.

---

## XII. Trade-offs and Decisions

- **Backward Compatibility**: The addition of the `Teacher` table is designed to integrate without adjustments to existing data models for `Student` and `Course`.
- **SQLite Continues**: Retained for its simplicity during continued development, providing a lightweight solution.
- **FastAPI Choice**: Continues to offer asynchronous capabilities and robust API documentation.

---

This implementation plan outlines a clear approach to integrating the `Teacher` entity into the existing Student Management Application, ensuring it meets the specified requirements while maintaining operational stability.

Existing Code Files:
### File: tests/api/test_teacher.py
```python
import pytest
from httpx import AsyncClient
from src.main import app  # Assuming the FastAPI app is instantiated in main.py
from src.database import init_db  # Function to initialize and access the database

@pytest.fixture(scope="module")
async def test_client():
    # Initialize the database before the tests and create the necessary tables
    await init_db()
    async with AsyncClient(app=app, base_url="http://test") as client:
        yield client  # This allows the tests to use the client
```

### Modifications Needed:
1. **Add Teacher Endpoint**: Introduce a new POST endpoint for creating teachers in `src/api/teacher.py`.
2. **Retrieve Teachers Endpoint**: Add a GET endpoint to fetch teacher data in the same file.
3. **Update database initializer** to include the `Teacher` model. Ensure migrations scripts cover the creation of the `teachers` table.
