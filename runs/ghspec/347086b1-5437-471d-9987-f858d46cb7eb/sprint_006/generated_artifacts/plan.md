# Implementation Plan: Add Teacher Relationship to Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Teacher Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Add Course Relationship to Student Entity

---

## I. Project Overview

This implementation plan outlines the integration of a new **Teacher relationship** to the existing **Course** entity within the Educational Management System. The feature aims to establish a one-to-many relationship where a teacher can be associated with multiple courses. This will facilitate better management and tracking of educational resources, ultimately enhancing the system's functionality. The plan details the architectural components, database schema updates, API modifications, and testing strategies required to fulfill the specified functional requirements.

## II. Technical Architecture

### 1. Architectural Style
- The existing microservices architecture will be enhanced by adding a relationship between the Course and Teacher entities, continuing with the same modular, RESTful API style implemented for previous entities.

### 2. Technology Stack
- **Programming Language**: Python 3.11+
- **Web Framework**: FastAPI
- **Database**: SQLite
- **ORM**: SQLAlchemy
- **Testing Framework**: pytest
- **Documentation**: OpenAPI (auto-generated by FastAPI)
- **Environment Management**: `venv` for virtual environments

## III. Module Design

### 1. Module Boundaries
- **Course Model**: Update `src/models/course.py` to include the `teacher_id` field.
- **Course API**: Update `src/routes/course.py` to include endpoints for assigning a Teacher to a Course and retrieving Courses with Teacher details.
- **Database Configuration**: Extend existing database configuration for schema migration handling and ensure compatibility with previous versions.
- **Input Validation**: Update input validation processes for Course assignments.

### 2. Responsibilities
- **Course Model**: Now incorporates a reference to the Teacher entity (`teacher_id`).
- **Course API**: Manages HTTP requests for assigning teachers to courses and retrieving course-teacher relationships.
- **Database Configuration/Schema Migration**: Handles the database migration for the Course entity's modification.
- **Input Validation**: Validates incoming assignment data for teacher assignments.

### 3. Data Models
```python
# src/models/course.py
from sqlalchemy import Column, Integer, String, ForeignKey
from sqlalchemy.orm import relationship

class Course(Base):
    __tablename__ = 'courses'

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String, nullable=False)
    level = Column(String, nullable=False)
    teacher_id = Column(Integer, ForeignKey('teachers.id'), nullable=True)  # new field for teacher reference

    # Relationship to the Teacher
    teacher = relationship("Teacher", back_populates="courses")

# Modification in Teacher model to accommodate this relationship
# src/models/teacher.py remains unchanged, but should include:
class Teacher(Base):
    __tablename__ = 'teachers'
    courses = relationship("Course", back_populates="teacher")  # relationship to access courses taught by the teacher
```

## IV. Database Design

### 1. Schema Update and Migration
- The existing `courses` table will be updated to include the new `teacher_id` field, establishing a relationship with the `teachers` table.

**Migration Strategy**:
- Create an Alembic migration that alters the `courses` table.
```python
# migrations/versions/xxxx_add_teacher_relationship_to_courses.py

"""Add teacher relationship to courses

Revision ID: xxxx
Revises: (previous revision)
Create Date: (create date)
"""

from alembic import op
import sqlalchemy as sa

revision = 'xxxx'
down_revision = 'previous_revision'

def upgrade() -> None:
    # Add teacher_id column to courses table
    op.add_column('courses', sa.Column('teacher_id', sa.Integer(), sa.ForeignKey('teachers.id'), nullable=True))

def downgrade() -> None:
    # Remove teacher_id column from courses table
    op.drop_column('courses', 'teacher_id')
```

### 2. Automatic Database Schema Creation
- The database initialization function will be modified to accommodate the new relationship for the Course and Teacher entities, ensuring they are created properly on startup.

```python
# src/database.py
def init_db():
    from models.course import Base as CourseBase
    # Ensure all existing models are imported for migration support
    Base.metadata.create_all(bind=engine)  # Create all tables including changes
    alembic_cfg = Config("alembic.ini")
    command.upgrade(alembic_cfg, "head")  # Run migrations
```

## V. API Design

### 1. Endpoints
- **POST /courses/{course_id}/assign_teacher**: To assign a Teacher to an existing Course.
  - **Request Body**:
    ```json
    {
      "teacher_id": 1
    }
    ```
  - **Responses**:
    - **200 OK** upon successful assignment: 
      ```json
      {
        "message": "Teacher assigned successfully."
      }
      ```
    - **400 Bad Request** when `teacher_id` is not provided or is invalid:
      ```json
      {
        "error": {
          "code": "E002",
          "message": "A valid Teacher ID must be provided."
        }
      }
      ```

- **GET /courses/{course_id}**: To retrieve Course details including assigned Teacher.
  - **Responses**:
    - **200 OK**: 
      ```json
      {
        "id": 1,
        "name": "Mathematics",
        "level": "Intermediate",
        "teacher": {
          "id": 2,
          "name": "John Doe",
          "email": "john.doe@example.com"
        }
      }
      ```
    - **404 Not Found** if the Course does not exist.

### 2. Error Handling
- Implement error handling in the API endpoints for assigning teachers to handle invalid `teacher_id` gracefully, providing meaningful error feedback in the JSON format, including specific error codes.

## VI. Testing Strategy

### 1. Test Coverage
- Introduce automated tests specifically for Course-Teacher functionalities, ensuring a minimum of 70% coverage for new features, with specific focus on validation and assignment logic.

### 2. Test Types
- **Unit tests**: For Course API functionality regarding teacher assignment.
- **Integration tests**: To ensure the API works with the SQLite database, including the correct relationships.

### 3. Test Organization
- Following existing test structure:
  - Source Code: `src/`
  - Tests: `tests/`
    - For Course API updates: `tests/test_course.py`

### 4. Example Unit Test
```python
# tests/test_course.py

def test_assign_teacher_to_course(client):
    response = client.post("/courses/1/assign_teacher", json={"teacher_id": 1})
    assert response.status_code == 200
    assert response.json() == {"message": "Teacher assigned successfully."}

def test_assign_teacher_without_id(client):
    response = client.post("/courses/1/assign_teacher", json={})
    assert response.status_code == 400
    assert response.json()["error"]["code"] == "E002"  # Validation error for teacher_id

def test_get_course_with_teacher(client):
    response = client.get("/courses/1")
    assert response.status_code == 200
    assert "teacher" in response.json()  # Ensure teacher details are included
```

## VII. Configuration Management

### 1. Environment Variables
- Document the completion of any required environment variables for the database configurations and migrations.

### 2. Sensible Defaults
- Ensure that configurations provide sensible defaults for local testing, promoting efficiency in the development cycle.

## VIII. Logging & Monitoring

- Implement structured logging for course operations.
```python
# In the API route implementation
logger.info("Assigning teacher ID %s to course ID %s", teacher_id, course_id)
```

## IX. Success Criteria Verification

- Validate that the following conditions are fulfilled:
  1. API endpoint for assigning a Teacher returns a 200 status with a success message.
  2. API returns a 400 Bad Request status when a required field (teacher_id) is missing.
  3. A valid GET request retrieves correct course information, including details of the assigned Teacher.

This plan provides a structured approach to integrating the Teacher relationship into the Course entity while ensuring adherence to specified functional requirements and maintaining overall system integrity. The implementation strategy prioritizes backward compatibility, comprehensive testing, and robust error handling.