# Implementation Plan: Add Course Relationship to Student Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Add Email Field to Student Entity

## Version: 1.0.0  
**Purpose**: To outline the technical architecture, technology stack, implementation approach, and module design for adding a relationship between the Student and Course entities in the existing application.

---

## I. Project Architecture

### 1.1 Application Design
This implementation will enhance the existing microservices architecture by establishing a many-to-many relationship between the Student and Course entities. FastAPI will continue to be used for building APIs, while SQLAlchemy will manage the data relationships and migrations.

### 1.2 Technology Stack
- **Backend Framework**: FastAPI (Python 3.11+)
- **Database**: SQLite
- **Data Access Layer**: SQLAlchemy for ORM
- **API Documentation**: Swagger (automatically generated by FastAPI)
- **Testing Framework**: pytest
- **Environment Variables**: python-dotenv for configuration management

---

## II. Module Design

### 2.1 Module Responsibilities
- **Relationship Management Module**
  - Extend the existing Student entity to include a many-to-many relationship with the Course entity using a join table `student_courses`.
  - Handle the API logic for enrolling students in courses and retrieving a student's enrolled courses.

### 2.2 Component Breakdown
- **API Endpoints**
  - `POST /students/{student_id}/courses`: Endpoint to enroll a student in specific courses.
  - `GET /students/{student_id}/courses`: Endpoint to retrieve all courses associated with a student.

---

## III. Database Migration Strategy

### 3.1 Schema Update
- Create a join table named `student_courses` that facilitates the many-to-many relationship:
  - **Table: student_courses**
    - `student_id`: Integer, foreign key referencing the Student entity.
    - `course_id`: Integer, foreign key referencing the Course entity.

#### Migration Script
```python
from sqlalchemy import create_engine, MetaData, Table
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "sqlite:///./students.db"
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def upgrade():
    """Create the join table for students and courses."""
    meta = MetaData(bind=engine)
    student_courses = Table(
        'student_courses',
        meta,
        autoload_with=engine
    )
    meta.create_all(engine, checkfirst=True) # Ensure the table gets created

def downgrade():
    """Drop the join table if it exists."""
    with engine.connect() as conn:
        conn.execute("DROP TABLE IF EXISTS student_courses;")

if __name__ == "__main__":
    upgrade()
```

---

## IV. API Design

### 4.1 API Endpoints

#### 4.1.1 Enroll a Student in Courses
- **Request** (POST /students/{student_id}/courses)
  - **URL Parameter**: 
    - `student_id`: Integer (the ID of the student).
  - **Body**:
    ```json
    {
      "course_ids": [1, 2, 3]
    }
    ```
- **Response** (201 Created)
  - **Body**:
    ```json
    {
      "message": "Courses successfully enrolled for student."
    }
    ```

#### 4.1.2 Retrieve a Student’s Courses
- **Request** (GET /students/{student_id}/courses)
- **Response** (200 OK)
  - **Body**:
    ```json
    [
      {
        "id": 1,
        "name": "Python Programming",
        "level": "Beginner"
      },
      {
        "id": 2,
        "name": "Data Science",
        "level": "Intermediate"
      }
    ]
    ```

### 4.2 Error Handling

#### 4.2.1 Common Error Responses
- **Invalid Course Association** (400 Bad Request)
  - **Response**:
    ```json
    {
      "error": {
        "code": "E001",
        "message": "One or more of the specified courses do not exist."
      }
    }
    ```

---

## V. Testing Strategy

### 5.1 Test Cases
- **Enroll a Student in Courses**: Validate successful enrollment and error handling for non-existent courses.
- **Retrieve Courses for a Student**: Verify that the correct courses are returned.

#### Sample Test Cases
- **Test enrolling a student in valid courses**.
- **Test enrolling a student with non-existent course IDs**.
- **Test retrieving courses for a student that has enrolled in courses**.
- **Test retrieving courses for a student with no enrolled courses**.

### 5.2 Testing Framework
- Use `pytest` to structure unit and integration tests.
- Use `httpx` for making requests to endpoints in tests.

---

## VI. Implementation Steps

1. **Project Setup**
   - Ensure the existing folder structure is maintained.
   - Update the virtual environment with any additional dependencies, if necessary.

2. **Database Schema Update**
   - Apply database migrations to introduce the `student_courses` table.
   - Ensure integrity and usability of the existing student and course data.

3. **API Endpoint Development**
   - Implement the `POST /students/{student_id}/courses` and `GET /students/{student_id}/courses` endpoints in `api/student.py`.

4. **Input Validation & Error Handling**
   - Implement input validations for course enrollment requests.
   - Define structured error responses for invalid inputs or when a student attempts to enroll in non-existent courses.

5. **Testing**
   - Write unit tests for the new features, ensuring that all scenarios are covered.
   - Run integration tests to confirm the end-to-end functionality.

6. **Documentation**
   - Update the API documentation generated by FastAPI to include the new endpoints and their usage.

---

## VII. Version Control Practices

### 7.1 Git Hygiene
- Use detailed commit messages that clarify the rationale for changes.
- Follow best practices for organizing commits, ensuring they are atomic.

---

## VIII. Conclusion

This implementation plan provides a detailed approach for establishing a relationship between students and courses within the application. It includes the necessary database changes, new API endpoints, and a comprehensive testing strategy to ensure robustness and reliability of functionality. This follows the existing coding standards and maintains backward compatibility with the current system.

### Existing Code Files Modifications:
1. Create new file: `api/student_courses.py` for new API endpoints related to course enrollment and retrieval.
2. Update `api/errors.py` to handle new error cases related to course associations.
3. Create new migration script for the `student_courses` join table.

### Existing Code Files:
- **models/student.py**: Update to reference the relationship with the Course entity through the `student_courses` join table.
- **api/student.py**: Implement new endpoints for enrolling courses and retrieving a student’s courses.
- **tests/test_student_courses.py**: New file for integration tests related to course enrollment functionality.