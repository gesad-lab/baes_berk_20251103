# Implementation Plan: Add Course Relationship to Student Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Create Course Entity

---
INCREMENTAL DEVELOPMENT CONTEXT

Previous Sprint Plan:
# Implementation Plan: Student Entity Management Application

---

## Version: 1.0.0
## Date: 2023-10-07

## Overview
This implementation plan outlines the technical changes required to establish a relationship between the Student and Course entities within the existing system. This feature will enable each Student to enroll in multiple courses, improving the educational management capabilities of the application. This plan details the modifications to the data model, related API contracts, and the overall implementation strategy while preserving existing student and course data integrity.

## Architecture
The existing architecture, which uses the FastAPI framework and SQLite for data storage, will remain largely unchanged. However, a new junction table will be introduced to facilitate the many-to-many relationship between the Student and Course entities. 

### System Components
1. **FastAPI Application**: The API will be enhanced to handle new endpoints related to student-course relationships.
2. **SQLite Database**: Updates will be made to create the junction table while ensuring existing data remains unaffected.
3. **Pydantic Models**: New models will be introduced to facilitate data validation for the relationship between Students and Courses.

## Technical Stack
- **Programming Language**: Python 3.11+
- **Web Framework**: FastAPI
- **Database**: SQLite
- **Data Validation**: Pydantic
- **Documentation**: OpenAPI (Automatically generated by FastAPI)
- **Testing Framework**: pytest

## Module Boundaries and Responsibilities

### Modules
1. **API Module**
   - Provide new RESTful endpoints to enroll a student in a course and retrieve enrolled courses.

2. **Database Module**
   - Implement required schema changes to include a junction table (StudentCourse).
   - Define a migration strategy to ensure that existing Student and Course data is preserved.

3. **Service Module**
   - Execute the business logic for managing the enrollment of students in courses and retrieving their course lists.

## Data Model

### Junction Table SQL Schema
The SQL schema for the new StudentCourse junction table is defined as follows:
```sql
CREATE TABLE student_course (
    student_id INTEGER,
    course_id INTEGER,
    PRIMARY KEY (student_id, course_id),
    FOREIGN KEY (student_id) REFERENCES student(id),
    FOREIGN KEY (course_id) REFERENCES course(id)
);
```

### Pydantic Models

```python
from pydantic import BaseModel, conint

class CourseEnrollment(BaseModel):
    course_id: conint(ge=1)  # Course ID must be a valid positive integer

class EnrolledCoursesResponse(BaseModel):
    course_ids: list[conint(ge=1)]  # List of enrolled course IDs
```

## API Contracts

### Endpoints
1. **POST /students/{student_id}/courses**
   - **Description**: Enroll a student in a course.
   - **Request Body**:
     ```json
     {
         "course_id": 1  // Required
     }
     ```
   - **Response**:
     - **201 Created**: On successful enrollment.
     - **400 Bad Request**: If the course ID is not valid.
     ```json
     {
         "error": {
             "code": "E001",
             "message": "Invalid course ID."
         }
     }
     ```

2. **GET /students/{student_id}/courses**
   - **Description**: Retrieve all courses associated with a student.
   - **Response**:
     ```json
     {
         "course_ids": [1, 2, 3]  // List of enrolled course IDs
     }
     ```

3. **GET /courses/{course_id}/students**
   - **Description**: Retrieve all students enrolled in a specific course.
   - **Response**:
     ```json
     {
         "student_ids": [1, 2]  // List of enrolled student IDs
     }
     ```

## Implementation Approach

### Setup
1. **Update Project Structure**: 
   - Introduce a new file `api/enrollment.py` for handling the student-course relationship functionalities.
   - Update `README.md` to include new API endpoint documentation.

### Development Steps
1. **Database Migration**: Implement a migration strategy utilizing `aiosqlite` to create the junction table:
   ```python
   import aiosqlite

   async def migrate():
       async with aiosqlite.connect("database.db") as db:
           await db.execute("""
               CREATE TABLE IF NOT EXISTS student_course (
                   student_id INTEGER,
                   course_id INTEGER,
                   PRIMARY KEY (student_id, course_id),
                   FOREIGN KEY (student_id) REFERENCES student(id),
                   FOREIGN KEY (course_id) REFERENCES course(id)
               )
           """)
           await db.commit()
   ```

2. **API Endpoints Creation**: Define the RESTful endpoints in `api/enrollment.py`:
   ```python
   from fastapi import APIRouter, HTTPException, Path
   from .models.enrollment import CourseEnrollment, EnrolledCoursesResponse
   
   router = APIRouter()

   @router.post("/students/{student_id}/courses", response_model=None)
   async def enroll_student(student_id: int, enrollment: CourseEnrollment):
       # Logic for enrolling a student in a course, handle validation 
       ...
   
   @router.get("/students/{student_id}/courses", response_model=EnrolledCoursesResponse)
   async def get_student_courses(student_id: int):
       # Logic to retrieve courses for the provided student ID
       ...
   
   @router.get("/courses/{course_id}/students")
   async def get_students_enrolled_in_course(course_id: int):
       # Logic to retrieve students enrolled in the specified course
       ...
   ```

3. **Validation and Error Handling**: Implement validation to ensure that attempts to enroll a student with an invalid course ID return an appropriate error response (404 Not Found).

4. **Testing**: Develop tests to ensure the functionality is working as expected, including testing:
   - Successful enrollment in a valid course.
   - Error responses for invalid course ID attempts.

Example Test Case:
```python
def test_enroll_student_with_invalid_course(client):
    response = client.post("/students/1/courses", json={"course_id": 999})
    assert response.status_code == 404  # Assuming 404 Not Found
```

## Scalability Considerations
The design remains stateless and efficient to accommodate future scalability, addressing possible increases in course and student data interactions.

## Security Considerations
Maintain existing security practices, ensuring data inputs are sanitized to prevent SQL injection and securing sensitive configurations using environment variables.

## Deployment Considerations
- Implement a careful deployment strategy that verifies the success of migrations and confirms the absence of any interruptions to current operations.
- Use Docker or similar containers for consistent environments.

## Documentation
- Update the API documentation to include new endpoints and their respective request/response formats.
- Provide example payloads and expected outcomes in the API section of `README.md`.

## Testing Strategy
Target at least 70% code coverage on newly introduced enrollment features, focusing on the registration and retrieval processes, along with meaningful error responses.

## Conclusion
This implementation plan details a structured approach to successfully integrate the relationship between Students and Courses within the existing system. All modifications related to data models, API contracts, and internal logic are outlined to ensure smooth implementation and adherence to the provided specifications.

### Example Integrating Files
File: `api/enrollment.py` (new file)
```python
from fastapi import APIRouter, HTTPException, Path
from .models.enrollment import CourseEnrollment, EnrolledCoursesResponse

router = APIRouter()

@router.post("/students/{student_id}/courses", response_model=None)
async def enroll_student(student_id: int, enrollment: CourseEnrollment):
    # Logic for enrolling a student in a course (to be implemented)
    pass

@router.get("/students/{student_id}/courses", response_model=EnrolledCoursesResponse)
async def get_student_courses(student_id: int):
    # Logic to retrieve courses for the provided student ID (to be implemented)
    pass

@router.get("/courses/{course_id}/students")
async def get_students_enrolled_in_course(course_id: int):
    # Logic to retrieve students enrolled in the specified course (to be implemented)
    pass
```

File: `tests/api/test_enrollment.py` (new file)
```python
import pytest
from fastapi.testclient import TestClient
from myapp.main import app  # Assuming your FastAPI app is defined in main.py

client = TestClient(app)

def test_enroll_student_with_valid_course():
    response = client.post("/students/1/courses", json={"course_id": 1})
    assert response.status_code == 201  # Assuming successful creation

def test_enroll_student_with_invalid_course():
    response = client.post("/students/1/courses", json={"course_id": 999})
    assert response.status_code == 404  # Invalid course ID
```

This comprehensive implementation plan serves as a roadmap for the effective incorporation of the student-course relationship feature, ensuring that the specified requirements are met efficiently and systematically.